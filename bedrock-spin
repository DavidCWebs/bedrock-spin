#!/bin/bash
#
# This script:

setup_bedrock() {

  echo -e "Please enter the full path to the new site, e.g. /var/www/html/newproject:"
  read WP_DIR

  # basename of the $DIR - used as the destination directory, under `/var/www/html`
  SITE_NAME=$(basename $WP_DIR)

  # Create new directory and use WP-CLI to download WordPress
  composer create-project roots/bedrock $WP_DIR
  sudo chown -R $USER $WP_DIR
  cd $WP_DIR

  echo "The new Bedrock site has been created at $WP_DIR"
  echo "It is owned by \"$USER\""

}

# ------------------------------------------------------------------------------
# Build new database
#
# Username is just the "salted" db name. For publicly accessible databases,
# consider making this more secure.
# ------------------------------------------------------------------------------

setup_database() {

  echo -e "This script will create a local database with a new user."
  echo -e "Enter the name of the new database:"
  read  DB_NAME

  DB_USER=$DB_NAME
  DB_USER+=_user

  echo -e "Enter a STRONG password for the new database:"
  read DB_PASS

  # For security purposes, ask for a table prefix. Default to 'wp_'
  DB_PREFIX=wp_
  echo -e "Please enter a database table prefix. Leave out the underscore. Defaults to 'wp_'."
  read DB_PREFIX
  DB_PREFIX+="_"

  if [ "$DB_PREFIX" = "" ]; then
    $DB_PREFIX=wp_
  fi

  echo -e "Enter the MySQL root password:"
  read  ROOT_PASSWORD

  DB_ARGS="CREATE DATABASE $DB_NAME;GRANT ALL PRIVILEGES ON $DB_NAME.* TO $DB_USER@localhost IDENTIFIED BY '$DB_PASS';FLUSH PRIVILEGES;"
  mysql -u root -p$ROOT_PASSWORD -e "$DB_ARGS"

  if [ $? != "0" ]; then  # NB "0" is the return from successful completion of the previous operation in BASH.
    echo "[Error]: Database creation failed"
    exit 1
  #else

  fi

}

# ------------------------------------------------------------------------------
# Set up wp-config.php using WP-CLI
# ------------------------------------------------------------------------------
configure_database() {

  WP_PATH=http://localhost/$SITE_NAME

  # ----------------------------------------------------------------------------
  # Install WordPress. WP-CLI.
  # ----------------------------------------------------------------------------
  echo -e "Enter a strong password for WordPress - your database might be exported to a publicly accessible server, so please set a strong password."
  read WP_PASS

  echo -e "Enter a username. NOT 'ADMIN'!"
  read WP_USERNAME

  wp core install --url=$WP_PATH --title="Basic Test Site" --admin_user=$WP_USERNAME --admin_password=$WP_PASS --admin_email=info@carawebs.com

  # discourage search engines
  wp option update blog_public 0

  # delete sample page, and create homepage
  wp post delete $(wp post list --post_type=page --posts_per_page=1 --post_status=publish --pagename="sample-page" --field=ID --format=ids)
  wp post create --post_type=page --post_title=Home --post_status=publish --post_author=$(wp user get $WP_USERNAME --field=ID --format=ids)
  wp post create --post_type=page --post_title=About --post_status=publish --post_author=$(wp user get $WP_USERNAME --field=ID --format=ids)

  # delete readme and license
  rm license.txt
  rm readme.html

  # set homepage as front page
  wp option update show_on_front 'page'

  # set homepage to be the new page
  wp option update page_on_front $(wp post list --post_type=page --post_status=publish --posts_per_page=1 --pagename=home --field=ID --format=ids)

  # set pretty urls
  wp rewrite structure '/%postname%/' --hard
  wp rewrite flush --hard

  # delete akismet and hello dolly
  # wp plugin delete akismet
  # wp plugin delete hello

  echo "------------------------------------------"
  echo " WordPress has been installed successfully: $WP_PATH "
  echo "------------------------------------------"
  echo " DB Info: "
  echo ""
  echo " DB Name: $DB_NAME"
  echo " DB User: $DB_USER"
  echo " DB Pass: $DB_PASS"
  echo "------------------------------------------"
  echo " WordPress User details:"
  echo ""
  echo " WP username: $WP_USERNAME"
  echo " WP password: $WP_PASS"

}

create_config() {

  touch $WP_DIR/.env

  nl=$'\n'
  read -r -d '' CONFIG_ARGS << EOF
DB_NAME=$DB_NAME
DB_USER=$DB_USER
DB_PASSWORD=$DB_PASS
DB_HOST=localhost
DB_PREFIX=$DB_PREFIX

WP_ENV=development
WP_HOME=http://localhost/$SITE_NAME/web
WP_SITEURL=http://localhost/$SITE_NAME/web/wp
EOF

SALTS=$(node /home/david/bash-projects-public/bedrock-spin/generate-salts.js)
#SALTS=$(wp dotenv salts generate)

COMBINED_CONFIG=${CONFIG_ARGS}$'\n\n'${SALTS}

printf "%s" "$COMBINED_CONFIG" > $WP_DIR/.env

cd $WP_DIR
wp dotenv salts regenerate

}

# ------------------------------------------------------------------------------
# Let's go!
# ------------------------------------------------------------------------------
setup_bedrock
setup_database
create_config
configure_database
